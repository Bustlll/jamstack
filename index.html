<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSG</title>
  
    <link rel="icon" type="image/x-icon" href="sshot.ico">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" />    
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script> 
    <script src="loader.js"></script>
</head>
<body>


    
    
 


  
   <!-- navbar space -->
    <nav>
        <input type="checkbox" id="check">
        <label for="check">
            <i class="hidden-menu" id="hmenu">Menu</i>
        </label>
        <a href="#" class="logo">The Status Game</a>
        <ul>
            <li><a accesskey="a" href="index.html">Home</a></li>
            <li><a accesskey="q" href="profileMenu.html">Profile</a></li>
            <div>
                <input accesskey="d" type="checkbox" class="checkbox" id="chk"/>
                <label class="label" for="chk">
                    <i class="material-symbols-outlined" id="night" >clear_night</i>
                    <i class="material-symbols-outlined" id="day">sunny</i>

                    

                        
                    <div class="ball"></div>
                </label>
            </div>

        </ul>
    </nav>
    <!-- navbar space -->
    <div class="box" id="box"></div>
         
    <!-- main content space -->
    <div class="mainContent">
        <section class="one">
             <!-- table content space -->
            <table class="content-table" id="content-table">
                <thead>
                  <tr>
                    <th class="rank">#</th>
                    <th class="name">Name</th>
                    <th class="instagram">Instagram</th>
                    <th class="youtube">Youtube</th>
                    <th class="twitch">Twitch</th>
                    <th class="reddit">Reddit</th>
                    <th class="twitter">Twitter</th>
                    <th class="alive">Alive</th>
                    <th class="region">REG</th>
                 
                  </tr>
                </thead>
                <tbody id="cryptocurrencies">
                 
                </tbody>
              </table>

               <!-- table content space -->
        </section>

        

        <section class="two"><h1>Two</h1>
        
            <h1>Hello world</h1>
            <button onclick="insertUser(),location.reload()" type="button"class="btnSocials">Add myself</button>
            <div class="header"></div>


            </section>

            <div class="centered" id="loading"><IMG SRC="Looped.gif"></div>

           
        <section class="three"><h1>Three</h1>
            
        
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script> 
    <scrip src="https://code.jquery.com/jquery-3.6.0.min.js"></scrip>   
    
    <script>




        //dark mode switch
        
        const chk = document.getElementById('chk');
            chk.addEventListener('change', () => {
	        document.body.classList.toggle('white');     
            });

        //Confetti
function confet() {
    var box = document.getElementById("box");
    var colors = ['red', 'green', 'blue', 'yellow', 'purple', 'orange', 'pink'];
for (var i = 0; i < 1500; i++) {
    var div = document.createElement("div");
    div.classList.add("confetti");
    box.appendChild(div);
}
var confetti = document.querySelectorAll('.confetti');
for (var i = 0; i < confetti.length; i++) {
        var size = Math.random() * 0.01 * [i];
        confetti[i].style.width = 5 + size + 'px';
        confetti[i].style.height = 16 + size + 'px';
        confetti[i].style.left = Math.random() * innerWidth + 'px';
        var background = colors[Math.floor(Math.random() * colors.length)];
        confetti[i].style.backgroundColor = background;
        box.children[i].style.transform = "rotate("+ size*[i] +"deg)";
}
}

//loading screen
// window.onload = function() {
//     $('#loading').fadeOut();
//     $('body').removeClass('hidden');

// }

   //sorting table content
    const SUPABASE_DATABASE = process.env.SUPABASE_DATABASE;
    const finalSupabaseUrl = process.env.FINAL_SUPABASE_URL;
    let ids;
    let rowPos;
    let indexPos = [];

            function getRowPositions(element) {
            var rowJavascript = element.parentNode.parentNode;
            var rowjQuery = $(element).closest("tr");
            let a = rowJavascript.rowIndex -1;
            indexPos.push(a);
            localStorage.setItem('ID', a);
            localStorage.ID = a;
        }

        var xhReq = new XMLHttpRequest();
        xhReq.open("GET", SUPABASE_DATABASE, false,);
        xhReq.send(null);
        const data1 = JSON.parse(xhReq.responseText); 
        // let data = JSON.stringify(data1[0].cash);
        const data = JSON.stringify(data1);
        // alert(JSON.stringify(data1[3].name))
      
        // initialization
        var cryptocurrencies;
        var timerId;
        var updateInterval = 2000000;
       

     
        // function ascending(a, b) { return a.percent_change_24h > b.percent_change_24h ? 1 : -1; }
        function descending(a, b) { return a.percent_change_24h < b.percent_change_24h ? 1 : -1; }     



        function reposition() {
            var height = $("#cryptocurrencies .cryptocurrency").height();
            var y = height;
            for(var i = 0; i < cryptocurrencies.length; i++) {
                cryptocurrencies[i].$item.css("top", y + "px");
                y += height;			
            }
        }  
        function updateRanks(cryptocurrencies) {
            for(var i = 0; i < cryptocurrencies.length; i++) {
                cryptocurrencies[i].$item.find(".rank").text(i + 1);	
            }
        }

        function fetchNewData(data,attributeName,name){
            for(var x in data){
                if((data[x].name == name) == true) {
                    return data[x][attributeName];
                }
            }
            return null;
        }      
          

        function getNewData(){
            // get the new data for each coin and change to their new values
            var newReq = new XMLHttpRequest();
            newReq.open("GET", SUPABASE_DATABASE, false);
            newReq.send(null);
            var newData1 = JSON.parse(newReq.responseText); 
            var newData = JSON.stringify(newData1);


            updateRanks(cryptocurrencies);
            reposition();
            console.log('Finished retrieving new data');
            
        }
        function leaderboards(users) {
  return users.sort((a, b) => b.cash-a.cash);
}
leaderboards(data1);
    
        function resetBoard() {
            var $list = $("#cryptocurrencies");
            $list.find(".cryptocurrency").remove();
            if(timerId !== undefined) {
                clearInterval(timerId);
            }

           
            cryptocurrencies = [];
            for(let i = 0;i < 11;i++){
    //function for comparing dates from server as the old time and client as the new time
                function compareData(){
                    let parsed1 = data1[i].Date; 
                    let newTime = new Date();
                    let newTfact = newTime.getTime();
                    let diferenceTime = newTfact - parsed1;
                    let differenD = Math.floor(diferenceTime / (1000 * 3600 * 24));
                    return differenD + " days";
                }
                
                cryptocurrencies.push(
                    {
                        name : data1[i].name,
                        instagram: data1[i].instagram,
                        youtube: data1[i].youtube,
                        twitch: data1[i].twitch,
                        reddit: data1[i].reddit,
                        twitter: data1[i].twitter,
                        alive: data1[i].alive,
                        region: data1[i].region,
                        alive: compareData(),
                        percent_change_24h: data1[i].cash,

                    }
                )
            }
      
           
            
            for(var i = 0; i < cryptocurrencies.length; i++) {
                var $item = $(
                    "<tr class='cryptocurrency'>" + 
                        "<th class='rank'>" + (i + 1) + "</th>" + 
                        "<td class='name'>" + cryptocurrencies[i].name + "</td>" + 
                        "<td class='instagram'>" + cryptocurrencies[i].instagram + "</td>" + 
                        "<td class='youtube'>" + cryptocurrencies[i].youtube + "</td>" + 
                        "<td class='twitch'>" + cryptocurrencies[i].twitch + "</td>" + 
                        "<td class='reddit'>" + cryptocurrencies[i].reddit + "</td>" + 
                        "<td class='twitter'>" + cryptocurrencies[i].twitter + "</td>" + 
                        // "<td class='percent_change_24h'>" + cryptocurrencies[i].percent_change_24h + "</td>" +
                        "<td class='ailve'>" + cryptocurrencies[i].alive + "</td>" + 
                        //this button executes 2 functions, get the row position and the action, add cash
                        "<td class='region'>" + cryptocurrencies[i].region + "&nbsp &nbsp" +"<button type='button' class='addmenubutt' id='addmenubuttid' onclick='getRowPositions(this),getIdsOfRow(), getRowOfButtAndAddCash()'>add</button>"+"</td>" +
                         

                    "</tr>"
                    
                );

                cryptocurrencies[i].$item = $item;
                $list.append($item);
             
            }
            cryptocurrencies.sort(descending);
            updateRanks(cryptocurrencies);
            reposition();
            
            // fetch new data for the updateInterval
            timerId = setInterval("getNewData();", updateInterval);

        }	
        resetBoard();

    
//functions for supabase
    

//add new user to supabase

function insertUser() {
    const userArr = JSON.parse(localStorage.getItem('User'));
    let userDate = JSON.parse(localStorage.getItem("today"))

    //modify data to get localstorage
    let data = {
    "cash": localStorage.cashy/100,
    "name": userArr[0].name,
    "instagram": userArr[0].instagram,
    "youtube": userArr[0].youtube,
    "twitch": userArr[0].twitch,
    "reddit": userArr[0].reddit,
    "twitter": userArr[0].twitter,
    "region": userArr[0].region,
    "Date": parseInt(localStorage.today),
};
//initialize xhr as a POST request
    let xhr = new XMLHttpRequest();
//open the request with the supabaseAPI calls
    xhr.open("POST", finalSupabaseUrl);
    xhr.setRequestHeader("Accept", "application/json");
    xhr.setRequestHeader("Content-Type", "application/json");
//Send the data in JSON format to the database
    xhr.send(JSON. stringify(data));
//show the changes for testing
    // alert(xhr.responseText);
}

//getRowPositions() func is called when pressed the add butt, it gets the position of the row.
//Then this function compares the position with the array and gets the id of supabase
function getIdsOfRow(){
    getRankId();
    let position = indexPos.slice(-1)
    let pparsed = Number(position)
        console.log(pparsed)

    let idTotal= ids[pparsed];
    console.log(idTotal)
    localStorage.setItem('IDTOT', idTotal)
    localStorage.IDTOT = idTotal
    // console.log(ids[localStorage.ID]);

}

function getRowPositions(element) {
            var rowJavascript = element.parentNode.parentNode;
            var rowjQuery = $(element).closest("tr");
            let a = rowJavascript.rowIndex -1;
            indexPos.push(a);
            localStorage.setItem('ID', a);
            localStorage.ID = a;
        }

//function for adding cash to one identifier
function getRowOfButtAndAddCash(){

    

    // getIdsOfRow();

    async function addCash() {
     
        // let storage = 69;
        const UPDATE_API = process.env.UPDATE_API; 
        const SUPABASE_UPDATE_CASH = process.env.SUPABASE_UPDATE_CASH;  

        
    const response = await fetch(SUPABASE_UPDATE_CASH); 
    const data = await response.json();
    let summed = Number(data[0].cash) + Number(localStorage.cashy/100);
    let oldData = {
            "cash": summed,
        };
        let xhr = new XMLHttpRequest();
            xhr.open("PATCH", UPDATE_API);
            xhr.setRequestHeader("Accept", "application/json");
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.send(JSON. stringify(oldData));
}
addCash();
}

function getRankId(){
    ids = [];
    let data1 = JSON.parse(data);
    let dataPars = leaderboards(data1);
    for(let i = 0;i < 11;i++){
    ids.push(dataPars[i].id);
    //this throws undefined, you have to check for ids to see array
    
}
}

    </script>

    <!-- main content space -->
</body>
</html>